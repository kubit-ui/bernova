#!/usr/bin/env node

/**
 * Bernova CSS Build Tool
 *
 * Minifies CSS files and outputs them to the specified distribution directory.
 * Reads configuration from bernova.config.json to determine output location.
 *
 * This script:
 * 1. Reads the main CSS file (bernova.css)
 * 2. Minifies it using CleanCSS
 * 3. Outputs the minified version to the configured directory
 *
 * Usage: bv-build
 */

const CleanCSS = require('clean-css');
const fs = require('fs').promises;
const path = require('path');
const { readConfigData } = require('../dist/helpers/readFile.utils.js');
(async () => {
  const { default: ora } = await import('ora');
  const spinner = ora('Starting CSS build process...').start();

  try {
    const configDir = path.resolve(process.cwd(), 'bernova.config.json');
    const configData = await readConfigData(configDir);
    const cssLocate = path.resolve(__dirname, '../styles/bernova.css');
    const { outputDir } = configData;

    // Verify CSS source file exists before processing
    let cssExists = true;
    try {
      await fs.access(cssLocate);
      spinner.succeed('Source CSS file found.');
    } catch (error) {
      cssExists = false;
      spinner.info('Source CSS file does not exist, will create default.');
    }

    // Create default CSS file if source doesn't exist
    if (!cssExists) {
      spinner.start('Creating default CSS file...');
      await fs.mkdir(path.dirname(cssLocate), { recursive: true });
      await fs.writeFile(
        cssLocate,
        '/* Generated by Bernova - run compilation first */'
      );
      spinner.succeed('Default CSS file created.');
    }

    // Read source CSS content
    spinner.start('Reading source CSS file...');
    const source = await fs.readFile(cssLocate, 'utf8');
    spinner.succeed('Source CSS file loaded successfully.');

    // Minify CSS using CleanCSS with optimization options
    spinner.start('Minifying CSS...');
    const cleanCSS = new CleanCSS({
      level: 2, // Advanced optimizations
      returnPromise: false,
    });
    const output = cleanCSS.minify(source);

    if (output.errors && output.errors.length > 0) {
      throw new Error(`CSS minification errors: ${output.errors.join(', ')}`);
    }

    spinner.succeed(
      `CSS minified successfully (${Math.round(
        (1 - output.styles.length / source.length) * 100
      )}% reduction).`
    );

    // Determine output directory and file path
    const buildLocate = outputDir || './dist';
    const buildDir = path.resolve(
      process.cwd(),
      buildLocate,
      'bernova.min.css'
    );

    // Ensure output directory exists
    spinner.start('Ensuring output directory exists...');
    await fs.mkdir(path.dirname(buildDir), { recursive: true });
    spinner.succeed('Output directory ready.');

    // Write minified CSS to output file
    spinner.start('Writing minified CSS to output file...');
    await fs.writeFile(buildDir, output.styles);
    spinner.succeed(`Minified CSS written to: ${buildDir}`);

    spinner.succeed('CSS build process completed successfully.');
  } catch (error) {
    spinner.fail('CSS build process failed.');
    console.error('Build error:', error.message);
    process.exit(1);
  }
})();
